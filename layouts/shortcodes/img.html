{{- /* ABOUTME: Inline image shortcode for embedding images within article text. */}}
{{- /* ABOUTME: Generates responsive thumbnails with WebP support, matching gallery behaviour. */}}
{{- /* Usage: {{< img src="photo.jpg" alt="Description" caption="Caption text" position="right" >}} */}}
{{- /* Optional: width="40%" blur="true" opacity="0.6" */}}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" -}}
{{- $caption := .Get "caption" | default "" -}}
{{- $position := .Get "position" | default "right" -}}
{{- $width := .Get "width" | default "40%" -}}
{{- $blur := .Get "blur" | default "false" -}}
{{- $opacity := .Get "opacity" | default "" -}}

{{- /* Resolve the image from page resources */ -}}
{{- $image := .Page.Resources.GetMatch $src -}}

{{- if $image -}}
{{- /* Generate responsive thumbnails matching gallery pattern */ -}}
{{- $thumb := $image.Fit "400x400" -}}
{{- $medium := $image.Fit "800x800" -}}
{{- $large := $image.Fit "1600x1600" -}}

<figure class="inline-image inline-image-{{ $position }}"{{ if ne $position "center" }} style="width: {{ $width }};"{{ end }}>
  <picture>
    {{- /* WebP source for modern browsers */ -}}
    {{- $thumbWebP := $thumb.Process "webp" -}}
    {{- $mediumWebP := $medium.Process "webp" -}}
    {{- $largeWebP := $large.Process "webp" -}}
    <source type="image/webp"
            srcset="{{ $thumbWebP.RelPermalink }} 400w, {{ $mediumWebP.RelPermalink }} 800w, {{ $largeWebP.RelPermalink }} 1600w"
            sizes="(max-width: 600px) 100vw, {{ $width }}">
    {{- /* Fallback for older browsers */ -}}
    <img src="{{ $medium.RelPermalink }}"
         srcset="{{ $thumb.RelPermalink }} 400w, {{ $medium.RelPermalink }} 800w, {{ $large.RelPermalink }} 1600w"
         sizes="(max-width: 600px) 100vw, {{ $width }}"
         alt="{{ $alt }}"
         loading="lazy"
         class="inline-image-img">
  </picture>
  {{- if $caption -}}
  <figcaption class="inline-image-caption{{ if eq $blur "true" }} inline-image-caption-blur{{ end }}"{{ if $opacity }} style="--inline-caption-opacity: {{ $opacity }};"{{ end }}>
    {{- $caption -}}
  </figcaption>
  {{- end -}}
</figure>
{{- else -}}
<!-- img shortcode: image "{{ $src }}" not found in page resources -->
{{- end -}}
