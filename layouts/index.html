<!DOCTYPE html>
<html>
{{ partial "header.html" . }}

<body data-grid-config='{{ .Scratch.Get "gridConfig" }}'>
	<div class="content">
		{{ partial "head.html" . }}
		<main class="home{{ if .Params.sidebar }} home-with-sidebar{{ end }}">
			<div class="site-description">
				{{- if isset .Site.Params "subtitle" -}}
				<p>{{ .Site.Params.Subtitle | .Page.RenderString }}</p>
				{{- end -}}
			</div>

			{{ if .Content }}
			<div class="homepage-content">
				{{ .Content }}
			</div>
			{{ end }}

			{{- /* Check for sidebar configuration */ -}}
			{{- $showSidebar := .Params.sidebar | default false -}}

			{{- /* Read list_style from frontmatter, default to cards (masonry) */ -}}
			{{- $listStyle := .Params.list_style | default "cards" -}}

			{{- /* Build page collections for all layout types */ -}}
			{{- /* Issue #1: Use mainSections from config instead of hardcoded names */ -}}
			{{- $sections := $.Site.Params.mainSections | default (slice "blog") -}}
			{{- $pinnedPages := slice -}}

			{{- /* Collect pinned/featured page from each section */ -}}
			{{- /* Issue #81: No hidden filter needed - Hugo's _build.list: false handles exclusion */ -}}
			{{- range $sections -}}
				{{- $section := . -}}
				{{- $sectionPages := slice -}}
				{{- /* Issue #1: Check for gallery folders (sections) in any section, not just "artwork" */ -}}
				{{- $sectionObj := $.Site.GetPage "section" $section -}}
				{{- if $sectionObj -}}
					{{- $gallerySections := where $sectionObj.Sections ".Params.gallery" true -}}
					{{- if gt (len $gallerySections) 0 -}}
						{{- /* This section has gallery folders - use them */ -}}
						{{- $sectionPages = $sectionObj.Sections -}}
					{{- else -}}
						{{- /* Regular content pages */ -}}
						{{- $sectionPages = where $.Site.RegularPages "Section" $section -}}
					{{- end -}}
				{{- end -}}
				{{- $pinned := where $sectionPages ".Params.pin" "!=" nil -}}

				{{- if gt (len $pinned) 0 -}}
					{{- /* Collect all pinned pages from this section */ -}}
					{{- range $pinned -}}
						{{- $pinnedPages = $pinnedPages | append . -}}
					{{- end -}}
				{{- else if gt (len $sectionPages) 0 -}}
					{{- /* No pinned pages: use most recent as representative */ -}}
					{{- $pinnedPages = $pinnedPages | append (index (first 1 $sectionPages) 0) -}}
				{{- end -}}
			{{- end -}}

			{{- /* Sort pinned pages by pin value (lowest first) across all sections */ -}}
			{{- /* Separate pages with pin values from those without */ -}}
			{{- $pagesWithPin := where $pinnedPages ".Params.pin" "!=" nil -}}
			{{- $pagesWithoutPin := where $pinnedPages ".Params.pin" "==" nil -}}
			{{- /* Sort pages with pins, then append unpinned pages */ -}}
			{{- $pinnedPages = sort $pagesWithPin ".Params.pin" "asc" -}}
			{{- range $pagesWithoutPin -}}
				{{- $pinnedPages = $pinnedPages | append . -}}
			{{- end -}}

			{{- /* Get all pages excluding pinned ones */ -}}
			{{- $pinnedPermalinks := slice -}}
			{{- range $pinnedPages -}}
				{{- $pinnedPermalinks = $pinnedPermalinks | append .RelPermalink -}}
			{{- end -}}

			{{- /* Issue #81: No hidden filter needed - Hugo's _build.list: false handles exclusion */ -}}
			{{- $remainingPages := slice -}}
			{{- range $.Site.RegularPages -}}
				{{- if not (in $pinnedPermalinks .RelPermalink) -}}
					{{- $remainingPages = $remainingPages | append . -}}
				{{- end -}}
			{{- end -}}
			{{- /* Issue #1: Include gallery sections from ANY section, not just "artwork" */ -}}
			{{- range $sections -}}
				{{- $sectionObj := $.Site.GetPage "section" . -}}
				{{- if $sectionObj -}}
					{{- range $sectionObj.Sections -}}
						{{- if and (not (in $pinnedPermalinks .RelPermalink)) (.Params.gallery) -}}
							{{- $remainingPages = $remainingPages | append . -}}
						{{- end -}}
					{{- end -}}
				{{- end -}}
			{{- end -}}

			{{- /* Combine: pinned first, then remaining by date */ -}}
			{{- $allPages := $pinnedPages -}}
			{{- range $remainingPages -}}
				{{- $allPages = $allPages | append . -}}
			{{- end -}}

			{{- /* Pagination: use frontmatter override if set, otherwise use site default (pagination.pagerSize) */ -}}
			{{- $paginator := .Paginate $allPages (.Params.paginate | default 12) -}}

			{{- /* Wrap in sidebar layout if sidebar is enabled */ -}}
			{{- if $showSidebar -}}
			<div class="sidebar-layout home-sidebar-layout">
				{{ partial "sidebar.html" (dict "sidebar" .Params.sidebar "context" . "Site" .Site) }}
				<div class="section-content home-main-content">
			{{- end -}}

			{{- /* Render based on list_style */ -}}
			{{- if eq $listStyle "gallery" -}}
				{{- /* Gallery mode: show sections as gallery cards */ -}}
				{{ partial "gallery-section.html" (dict "pages" .Site.Sections "context" . "Site" .Site) }}
			{{- else if eq $listStyle "list" -}}
				{{- /* List mode: simple vertical list */ -}}
				{{ partial "list-view.html" (dict "pages" $paginator.Pages "showSection" true "Site" .Site) }}
			{{- else -}}
				{{- /* Default cards mode: masonry grid with pin logic */ -}}
				{{ partial "masonry-grid.html" (dict "pages" $paginator.Pages "showSection" true "Site" .Site) }}
			{{- end -}}

			{{ partial "pagination.html" $paginator }}

			{{- if $showSidebar -}}
				</div>
			</div>
			{{- end -}}
		</main>
		{{ partial "footer.html" . }}
	</div>

	<script src="{{ "js/masonry-init.js" | relURL }}"></script>
</body>

</html>
