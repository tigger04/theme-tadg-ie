{{/* ABOUTME: Generates configurable responsive grid CSS from hugo.yaml params */}}
{{/* ABOUTME: Reads params.grid with fallback defaults matching original hardcoded values */}}

{{/* Read grid config: page-level frontmatter overrides site-level params, then defaults */}}
{{- $siteGrid := .Site.Params.grid | default dict -}}
{{- $pageGrid := .Params.grid | default dict -}}
{{- $siteBp := $siteGrid.breakpoints | default dict -}}
{{- $pageBp := $pageGrid.breakpoints | default dict -}}
{{- $siteCols := $siteGrid.columns | default dict -}}
{{- $pageCols := $pageGrid.columns | default dict -}}

{{/* Breakpoints: page → site → default */}}
{{- $bpSm := $pageBp.sm | default ($siteBp.sm | default "30em") -}}
{{- $bpMd := $pageBp.md | default ($siteBp.md | default "48em") -}}
{{- $bpLg := $pageBp.lg | default ($siteBp.lg | default "64em") -}}
{{- $bpXl := $pageBp.xl | default ($siteBp.xl | default "80em") -}}

{{/* Column counts: page → site → default */}}
{{- $colSm := $pageCols.sm | default ($siteCols.sm | default 2) -}}
{{- $colMd := $pageCols.md | default ($siteCols.md | default 3) -}}
{{- $colLg := $pageCols.lg | default ($siteCols.lg | default 4) -}}
{{- $colXl := $pageCols.xl | default ($siteCols.xl | default 5) -}}

{{/* Layout: page → site → default */}}
{{- $contentMaxWidth := $pageGrid.contentMaxWidth | default ($siteGrid.contentMaxWidth | default "100rem") -}}
{{- $sidebarWidth := $pageGrid.sidebarWidth | default ($siteGrid.sidebarWidth | default "15rem") -}}
{{- $sidebarWidthNarrow := $pageGrid.sidebarWidthNarrow | default ($siteGrid.sidebarWidthNarrow | default "12rem") -}}
{{- $gridGap := $pageGrid.gap | default ($siteGrid.gap | default "1.5rem") -}}

{{/* Calculate breakpoint + 0.0625em for min-width (avoids overlap) */}}
{{- $bpSmVal := strings.TrimSuffix "em" $bpSm | float -}}
{{- $bpMdVal := strings.TrimSuffix "em" $bpMd | float -}}
{{- $bpLgVal := strings.TrimSuffix "em" $bpLg | float -}}
{{- $bpXlVal := strings.TrimSuffix "em" $bpXl | float -}}

{{- $bpSmPlus := printf "%.4fem" (add $bpSmVal 0.0625) -}}
{{- $bpMdPlus := printf "%.4fem" (add $bpMdVal 0.0625) -}}
{{- $bpLgPlus := printf "%.4fem" (add $bpLgVal 0.0625) -}}
{{- $bpXlPlus := printf "%.4fem" (add $bpXlVal 0.0625) -}}

{{/* Build JSON config for JavaScript (masonry-init.js reads this from data-grid-config) */}}
{{- $gridConfig := dict
  "breakpoints" (dict "sm" $bpSmVal "md" $bpMdVal "lg" $bpLgVal "xl" $bpXlVal)
  "columns" (dict "sm" $colSm "md" $colMd "lg" $colLg "xl" $colXl)
-}}
{{- .Scratch.Set "gridConfig" ($gridConfig | jsonify) -}}

<style>
/* Issue #17: Configurable responsive grid — generated from params.grid */
:root {
  --content-max-width: {{ $contentMaxWidth }};
  --sidebar-width: {{ $sidebarWidth }};
  --sidebar-width-narrow: {{ $sidebarWidthNarrow }};
  --grid-gap: {{ $gridGap }};
}

/* Homepage grid responsive breakpoints */
@media (max-width: {{ $bpSm }}) {
  .homepage-grid {
    grid-template-columns: 1fr;
  }
}
@media (min-width: {{ $bpSmPlus }}) and (max-width: {{ $bpMd }}) {
  .homepage-grid {
    grid-template-columns: repeat({{ $colSm }}, 1fr);
  }
}
@media (min-width: {{ $bpMdPlus }}) and (max-width: {{ $bpLg }}) {
  .homepage-grid {
    grid-template-columns: repeat({{ $colMd }}, 1fr);
  }
}
@media (min-width: {{ $bpLgPlus }}) and (max-width: {{ $bpXl }}) {
  .homepage-grid {
    grid-template-columns: repeat({{ $colLg }}, 1fr);
  }
}

/* Masonry grid CSS fallback responsive breakpoints */
@media (max-width: {{ $bpSm }}) {
  .masonry-grid {
    grid-template-columns: repeat({{ $colSm }}, 1fr);
    gap: 1rem;
  }
  .masonry-item {
    transform: none !important;
    margin-top: 0 !important;
  }
  .masonry-grid.masonry-active {
    height: auto !important;
  }
}
@media (min-width: {{ $bpSmPlus }}) and (max-width: {{ $bpMd }}) {
  .masonry-grid {
    grid-template-columns: repeat({{ $colSm }}, 1fr);
    gap: 1.25rem;
  }
}
@media (min-width: {{ $bpMdPlus }}) and (max-width: {{ $bpLg }}) {
  .masonry-grid {
    grid-template-columns: repeat({{ $colMd }}, 1fr);
  }
}
@media (min-width: {{ $bpLgPlus }}) and (max-width: {{ $bpXl }}) {
  .masonry-grid {
    grid-template-columns: repeat({{ $colLg }}, 1fr);
  }
}
@media (min-width: {{ $bpXlPlus }}) {
  .masonry-grid {
    grid-template-columns: repeat({{ $colXl }}, 1fr);
  }
}

/* Sidebar layout masonry: sidebar takes one column, reduce content columns */
@media (max-width: {{ $bpMd }}) {
  .sidebar-layout .section-content .masonry-grid {
    grid-template-columns: repeat(1, 1fr) !important;
  }
}
@media (min-width: {{ $bpMdPlus }}) and (max-width: {{ $bpLg }}) {
  .sidebar-layout .section-content .masonry-grid {
    grid-template-columns: repeat({{ sub $colMd 1 }}, 1fr);
  }
}
@media (min-width: {{ $bpLgPlus }}) and (max-width: {{ $bpXl }}) {
  .sidebar-layout .section-content .masonry-grid {
    grid-template-columns: repeat({{ sub $colLg 1 }}, 1fr);
  }
}
@media (min-width: {{ $bpXlPlus }}) {
  .sidebar-layout .section-content .masonry-grid {
    grid-template-columns: repeat({{ sub $colXl 1 }}, 1fr);
  }
}

/* Sidebar width responsive */
/* Issue #23: Narrow sidebar between md and lg breakpoints */
@media (min-width: {{ $bpMdPlus }}) and (max-width: {{ $bpLg }}) {
  .sidebar-layout {
    grid-template-columns: min-content 1fr;
    gap: 1rem;
  }
  .section-sidebar {
    font-size: 0.875rem;
  }
  .sidebar-title {
    font-size: 1rem;
  }
  .section-nav a {
    padding: 0.375rem 0.5rem;
    font-size: 0.8125rem;
  }
}
/* Issue #23: Desktop — sidebar fits content, capped at 20% viewport */
@media (min-width: {{ $bpMdPlus }}) {
  .section-sidebar {
    max-width: 20vw;
    white-space: nowrap;
  }
  .sidebar-collapse-title {
    list-style: none;
    cursor: default;
    pointer-events: none;
    font-weight: 600;
    font-size: 1.25rem;
    margin: 0 0 1rem 0;
  }
  .sidebar-collapse-title::-webkit-details-marker {
    display: none;
  }
  .sidebar-collapse-title::after {
    display: none;
  }
}
/* Issue #23: Collapse sidebar to block at md breakpoint (48em) instead of sm (30em) */
@media (max-width: {{ $bpMd }}) {
  .sidebar-layout {
    display: block !important;
  }
  .section-sidebar {
    position: static;
    margin-bottom: 0.5rem;
  }
  /* Issue #23: Show collapsible summary toggle on mobile */
  .sidebar-collapse-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0.5rem 0;
    color: var(--text-color);
    list-style: none;
  }
  .sidebar-collapse-title::-webkit-details-marker {
    display: none;
  }
  .sidebar-collapse-title::after {
    content: '\25BC';
    font-size: 1.5rem;
    transition: transform 0.2s ease;
  }
  .sidebar-collapse[open] > .sidebar-collapse-title::after {
    transform: rotate(180deg);
  }
}
</style>
